# üîê Guide SSH et D√©ploiement Git sur LWS

## üìã Table des mati√®res
1. [Activer l'acc√®s SSH sur LWS](#1-activer-lacc√®s-ssh-sur-lws)
2. [Se connecter en SSH](#2-se-connecter-en-ssh)
3. [Configuration Git sur le serveur](#3-configuration-git-sur-le-serveur)
4. [D√©ploiement via Git](#4-d√©ploiement-via-git)
5. [Script de d√©ploiement automatis√©](#5-script-de-d√©ploiement-automatis√©)
6. [Troubleshooting](#6-troubleshooting)

---

## 1. Activer l'Acc√®s SSH sur LWS

### √âtape 1.1 : V√©rifier si SSH est disponible

1. Connectez-vous √† votre [Espace Client LWS](https://panel.lws.fr)
2. Allez dans **H√©bergement Web** ‚Üí **Votre h√©bergement**
3. Cherchez la section **"SSH"** ou **"Acc√®s SSH"**

### √âtape 1.2 : Activer SSH

**Si SSH est disponible :**
1. Cliquez sur **"Activer l'acc√®s SSH"**
2. Cr√©ez un mot de passe SSH (diff√©rent du mot de passe FTP)
3. Notez vos identifiants :
   ```
   H√¥te SSH: ssh.horizonimmo.com (ou ssh.cluster0XX.lws.fr)
   Port: 22
   Utilisateur: zbinv2677815
   Mot de passe: [Votre mot de passe SSH]
   ```

**‚ö†Ô∏è Si SSH n'est pas disponible :**
- SSH est disponible uniquement sur certaines formules LWS (g√©n√©ralement √† partir de l'offre Pro)
- Contactez le support LWS pour activer SSH ou upgrader votre formule

---

## 2. Se Connecter en SSH

### Option 1 : Depuis Windows (PowerShell ou CMD)

```bash
# Commande de connexion SSH
ssh zbinv2677815@ssh.horizonimmo.com

# Ou avec le port explicite
ssh -p 22 zbinv2677815@ssh.horizonimmo.com
```

**Lors de la premi√®re connexion :**
```
The authenticity of host 'ssh.horizonimmo.com' can't be established.
Are you sure you want to continue connecting (yes/no)?
```
‚Üí Tapez `yes` et appuyez sur Entr√©e

**Entrez votre mot de passe SSH** (il ne s'affichera pas √† l'√©cran)

### Option 2 : Avec PuTTY (Windows)

1. **T√©l√©chargez PuTTY** : https://www.putty.org/
2. **Configuration :**
   - Host Name: `ssh.horizonimmo.com`
   - Port: `22`
   - Connection type: `SSH`
3. Cliquez sur **"Open"**
4. Entrez votre login : `zbinv2677815`
5. Entrez votre mot de passe SSH

### Option 3 : Depuis Linux/Mac (Terminal)

```bash
ssh zbinv2677815@ssh.horizonimmo.com
```

### ‚úÖ V√©rification de la Connexion

Une fois connect√©, vous devriez voir :
```bash
zbinv2677815@lwsXXXXX:~$
```

Testez les commandes de base :
```bash
# Voir o√π vous √™tes
pwd
# R√©sultat attendu: /home/zbinv2677815

# Lister les fichiers
ls -la

# Aller dans le dossier Laravel
cd laravel-app
pwd
# R√©sultat attendu: /home/zbinv2677815/laravel-app
```

---

## 3. Configuration Git sur le Serveur

### √âtape 3.1 : V√©rifier si Git est install√©

```bash
git --version
```

**Si Git n'est pas install√© :**
```bash
# Sur LWS, Git est g√©n√©ralement pr√©install√©
# Si ce n'est pas le cas, contactez le support LWS
```

### √âtape 3.2 : Configurer Git (premi√®re fois uniquement)

```bash
# Configurer votre nom
git config --global user.name "Votre Nom"

# Configurer votre email
git config --global user.email "votre.email@example.com"

# V√©rifier la configuration
git config --list
```

### √âtape 3.3 : Se Placer dans le Bon Dossier

```bash
# Aller dans le dossier de l'application
cd /home/zbinv2677815/laravel-app

# V√©rifier qu'on est au bon endroit
pwd
ls -la
```

---

## 4. D√©ploiement via Git

### M√©thode 1 : Clonage Initial (Si pas encore fait)

**Si votre projet n'a pas encore √©t√© clon√© sur le serveur :**

```bash
# Se placer dans le dossier home
cd /home/zbinv2677815

# Cloner le d√©p√¥t GitHub
git clone https://github.com/simonet85/horizon-immo.git laravel-app

# Entrer dans le dossier
cd laravel-app
```

### M√©thode 2 : Mise √† Jour du Projet Existant

**Si le projet existe d√©j√† sur le serveur :**

```bash
# Se placer dans le dossier Laravel
cd /home/zbinv2677815/laravel-app

# V√©rifier l'√©tat de Git
git status

# R√©cup√©rer les derni√®res modifications
git pull origin main
```

**Si vous avez des modifications locales non commit√©es :**
```bash
# Sauvegarder temporairement vos changements locaux
git stash

# R√©cup√©rer les modifications du d√©p√¥t
git pull origin main

# R√©appliquer vos changements (si n√©cessaire)
git stash pop
```

### M√©thode 3 : R√©initialiser Compl√®tement (Reset Hard)

**‚ö†Ô∏è Attention : Cette commande √©crase TOUTES les modifications locales !**

```bash
# Se placer dans le dossier Laravel
cd /home/zbinv2677815/laravel-app

# R√©initialiser au dernier commit de GitHub
git fetch origin
git reset --hard origin/main

# Forcer la mise √† jour
git pull origin main
```

---

## 5. Script de D√©ploiement Automatis√©

### √âtape 5.1 : Cr√©er le Script de D√©ploiement

```bash
# Cr√©er le fichier de script
nano /home/zbinv2677815/laravel-app/deploy.sh
```

**Contenu du script `deploy.sh` :**

```bash
#!/bin/bash

echo "üöÄ D√©marrage du d√©ploiement..."

# Couleurs pour les messages
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Se placer dans le bon dossier
cd /home/zbinv2677815/laravel-app || exit

# Mode maintenance
echo -e "${YELLOW}üì¶ Activation du mode maintenance...${NC}"
php artisan down --message="Mise √† jour en cours. Retour dans quelques instants." || true

# Mise √† jour du code depuis Git
echo -e "${YELLOW}üîÑ R√©cup√©ration des derni√®res modifications...${NC}"
git fetch origin
git reset --hard origin/main
git pull origin main

# Installation des d√©pendances Composer
echo -e "${YELLOW}üì¶ Mise √† jour des d√©pendances Composer...${NC}"
composer install --no-dev --optimize-autoloader --no-interaction

# Vider les caches
echo -e "${YELLOW}üßπ Nettoyage des caches...${NC}"
php artisan config:clear
php artisan cache:clear
php artisan view:clear
php artisan route:clear
php artisan event:clear

# Reconstruire les caches
echo -e "${YELLOW}üî® Reconstruction des caches...${NC}"
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Ex√©cuter les migrations (si nouvelles)
echo -e "${YELLOW}üóÑÔ∏è Ex√©cution des migrations...${NC}"
php artisan migrate --force --no-interaction

# Cr√©er le lien symbolique storage (si pas encore fait)
echo -e "${YELLOW}üîó Cr√©ation du lien symbolique storage...${NC}"
php artisan storage:link || true

# V√©rifier les permissions
echo -e "${YELLOW}üîê V√©rification des permissions...${NC}"
chmod -R 775 storage bootstrap/cache

# D√©sactiver le mode maintenance
echo -e "${YELLOW}‚úÖ D√©sactivation du mode maintenance...${NC}"
php artisan up

echo -e "${GREEN}üéâ D√©ploiement termin√© avec succ√®s !${NC}"
echo ""
echo "üìä Informations :"
git log --oneline -1
echo ""
echo "‚úÖ Le site est maintenant √† jour et accessible."
```

**Enregistrer et quitter :**
- Appuyez sur `Ctrl + O` (pour sauvegarder)
- Appuyez sur `Entr√©e` (pour confirmer)
- Appuyez sur `Ctrl + X` (pour quitter)

### √âtape 5.2 : Rendre le Script Ex√©cutable

```bash
chmod +x /home/zbinv2677815/laravel-app/deploy.sh
```

### √âtape 5.3 : Ex√©cuter le Script

```bash
# Depuis le dossier laravel-app
./deploy.sh

# Ou depuis n'importe o√π
/home/zbinv2677815/laravel-app/deploy.sh
```

---

## 6. Workflow Complet de D√©ploiement

### Workflow Recommand√©

```bash
# 1. Se connecter en SSH
ssh zbinv2677815@ssh.horizonimmo.com

# 2. Aller dans le dossier du projet
cd /home/zbinv2677815/laravel-app

# 3. V√©rifier l'√©tat actuel
git status
git log --oneline -5

# 4. Ex√©cuter le d√©ploiement
./deploy.sh

# 5. V√©rifier que tout fonctionne
tail -f storage/logs/laravel.log
# Ctrl+C pour quitter

# 6. Se d√©connecter
exit
```

### Commandes Git Utiles

```bash
# Voir l'historique des commits
git log --oneline -10

# Voir les diff√©rences avec la version GitHub
git fetch origin
git diff origin/main

# Voir les fichiers modifi√©s
git status

# Voir les branches
git branch -a

# Changer de branche (si vous en avez plusieurs)
git checkout nom-de-branche

# Voir le dernier commit
git log -1

# Voir les fichiers d'un commit sp√©cifique
git show --name-only commit-hash
```

---

## 7. Troubleshooting

### Probl√®me 1 : "Permission denied (publickey)"

**Cause :** Vous essayez de cloner via SSH mais n'avez pas configur√© de cl√© SSH.

**Solution :**
```bash
# Utilisez HTTPS au lieu de SSH
git clone https://github.com/simonet85/horizon-immo.git laravel-app
```

### Probl√®me 2 : "fatal: not a git repository"

**Cause :** Vous n'√™tes pas dans un dossier Git.

**Solution :**
```bash
# V√©rifiez que vous √™tes dans le bon dossier
cd /home/zbinv2677815/laravel-app
ls -la .git
```

### Probl√®me 3 : "error: Your local changes would be overwritten"

**Cause :** Vous avez des modifications locales non commit√©es.

**Solution 1 (Sauvegarder les changements) :**
```bash
git stash
git pull origin main
```

**Solution 2 (√âcraser les changements locaux) :**
```bash
git fetch origin
git reset --hard origin/main
```

### Probl√®me 4 : "Composer: command not found"

**Cause :** Composer n'est pas install√© ou pas dans le PATH.

**Solution :**
```bash
# V√©rifier l'emplacement de Composer
which composer

# Si Composer est dans ~/.composer
~/.composer/vendor/bin/composer install

# Ou utiliser le chemin complet
/usr/local/bin/composer install
```

### Probl√®me 5 : Erreur 500 apr√®s d√©ploiement

**V√©rifications :**
```bash
# 1. V√©rifier les permissions
chmod -R 775 storage bootstrap/cache

# 2. V√©rifier le fichier .env
cat .env | grep APP_KEY

# 3. G√©n√©rer une nouvelle cl√© si n√©cessaire
php artisan key:generate

# 4. Vider tous les caches
php artisan optimize:clear
```

### Probl√®me 6 : "Could not resolve host: github.com"

**Cause :** Probl√®me de DNS ou de connexion internet du serveur.

**Solution :**
```bash
# Tester la connexion
ping github.com

# Si √ßa ne fonctionne pas, contactez le support LWS
```

---

## 8. S√©curit√© et Bonnes Pratiques

### ‚úÖ √Ä Faire

1. **Toujours faire un backup avant d√©ploiement**
   ```bash
   cp -r /home/zbinv2677815/laravel-app /home/zbinv2677815/laravel-app-backup-$(date +%Y%m%d)
   ```

2. **Utiliser le mode maintenance**
   ```bash
   php artisan down
   # ... d√©ploiement ...
   php artisan up
   ```

3. **V√©rifier les logs apr√®s d√©ploiement**
   ```bash
   tail -f storage/logs/laravel.log
   ```

4. **Tester sur staging avant production** (si vous avez un environnement de staging)

### ‚ùå √Ä √âviter

1. ‚ùå Ne jamais √©diter les fichiers directement sur le serveur
2. ‚ùå Ne jamais commiter le fichier `.env`
3. ‚ùå Ne pas ex√©cuter `composer update` en production (utiliser `composer install`)
4. ‚ùå Ne pas oublier de vider les caches apr√®s d√©ploiement

---

## 9. Commandes de Diagnostic Utiles

```bash
# V√©rifier la version PHP
php -v

# V√©rifier les extensions PHP
php -m

# V√©rifier l'espace disque
df -h

# V√©rifier la m√©moire
free -h

# Voir les processus PHP en cours
ps aux | grep php

# V√©rifier les permissions
ls -la storage/
ls -la bootstrap/cache/

# V√©rifier la configuration Laravel
php artisan about

# Tester la connexion √† la base de donn√©es
php artisan tinker
>>> DB::connection()->getPdo();
>>> exit
```

---

## 10. Alternative : D√©ploiement Automatis√© via GitHub Actions

Si vous voulez automatiser compl√®tement le d√©ploiement, vous pouvez utiliser GitHub Actions :

**Fichier `.github/workflows/deploy.yml` :**

```yaml
name: Deploy to LWS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: 22
        script: |
          cd /home/zbinv2677815/laravel-app
          ./deploy.sh
```

**Configurer les secrets GitHub :**
1. Allez dans **Settings ‚Üí Secrets and variables ‚Üí Actions**
2. Ajoutez :
   - `SSH_HOST` : `ssh.horizonimmo.com`
   - `SSH_USERNAME` : `zbinv2677815`
   - `SSH_PASSWORD` : Votre mot de passe SSH

---

## üìä R√©sum√© Rapide

**Connexion SSH :**
```bash
ssh zbinv2677815@ssh.horizonimmo.com
```

**D√©ploiement Rapide :**
```bash
cd /home/zbinv2677815/laravel-app
./deploy.sh
```

**Mise √† jour manuelle :**
```bash
cd /home/zbinv2677815/laravel-app
git pull origin main
composer install --no-dev --optimize-autoloader
php artisan migrate --force
php artisan optimize:clear
php artisan optimize
```

---

## üìö Ressources

- üìñ [Guide de d√©ploiement initial](CLAUDE.md)
- üîÑ [Guide de mise √† jour FTP](GUIDE_MISE_A_JOUR_LWS.md)
- ‚úÖ [Checklist rapide](UPDATE_CHECKLIST.md)
- üìã [Fichiers √† uploader](FILES_TO_UPLOAD.txt)

---

**üéâ Vous √™tes maintenant pr√™t √† d√©ployer via Git sur LWS !**
